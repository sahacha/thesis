import pandas as pd
from typing import List, Dict
import google.generativeai as genai
import random
import json
import os

# สมมติว่าคุณได้ตั้งค่า API key ของ Google Generative AI แล้ว
genai.configure(api_key="AIzaSyDqOBk5pb7oZuoy1i1pRrFG0WxeosgKPzA")

model = genai.GenerativeModel('gemini-2.0-flash')

# --- ตัวอย่าง Scraped Data (จำลองจากที่คุณมีจริง) ---
# ในความเป็นจริง คุณจะโหลดข้อมูลนี้มาจากไฟล์ JSON/CSV หรือฐานข้อมูลของคุณ
scraped_data = [
    {
        "id": 1,
        "ชื่อสถานที่/ร้านอาหาร": "วัดสวนดอก",
        "ประเภท": "วัด/สถานที่ท่องเที่ยว",
        "รายละเอียด": "วัดเก่าแก่ในตัวเมืองเชียงใหม่ สร้างในสมัยล้านนา มีเจดีย์ทรงลังกาและพระบรมสารีริกธาตุ สถาปัตยกรรมล้านนาอันงดงาม เหมาะสำหรับสายบุญและผู้สนใจประวัติศาสตร์",
        "การเดินทาง": "ถนนสุเทพ ตำบลสุเทพ อำเภอเมืองเชียงใหม่ ใกล้มหาวิทยาลัยเชียงใหม่",
        "เวลาเปิด-ปิด": "ทุกวัน 06.00-17.00 น.",
        "ฤดูกาลแนะนำ": "พฤศจิกายน-กุมภาพันธ์",
        "ช่วงเวลาที่ดีที่สุด": "07.00-09.00 น.",
        "อัตราค่าเข้า": "ฟรี",
        "แผนเที่ยว": "สายบุญ/ประวัติศาสตร์/ครอบครัว"
    },
    {
        "id": 2,
        "ชื่อสถานที่/ร้านอาหาร": "ถนนคนเดินวัวลาย",
        "ประเภท": "ถนนคนเดิน/ตลาด",
        "รายละเอียด": "ตลาดนัดคืนวันเสาร์ ใกล้ประตูท่าแพ มีอาหารพื้นเมือง งานฝีมือล้านนา และเครื่องเงินจากหมู่บ้านช่างเงิน สัมผัสวัฒนธรรมท้องถิ่น",
        "การเดินทาง": "ถนนวัวลาย ตำบลหายยา อำเภอเมืองเชียงใหม่",
        "เวลาเปิด-ปิด": "วันเสาร์ 17.00-23.00 น.",
        "ฤดูกาลแนะนำ": "พฤศจิกายน-ธันวาคม",
        "ช่วงเวลาที่ดีที่สุด": "18.00-20.00 น.",
        "อัตราค่าเข้า": "ฟรี",
        "แผนเที่ยว": "สายกิน/ช้อปปิ้ง/วัฒนธรรม"
    },
    {
        "id": 3,
        "ชื่อสถานที่/ร้านอาหาร": "ร้านข้าวซอยเสมอใจ",
        "ประเภท": "ร้านอาหาร",
        "รายละเอียด": "ร้านข้าวซอยชื่อดัง รสชาติเข้มข้นแบบฉบับล้านนา เสิร์ฟพร้อมหมู ไก่ หรือเนื้อ บรรยากาศเรียบง่าย เหมาะสำหรับลิ้มลองอาหารเหนือ",
        "การเดินทาง": "ถนนเจริญราษฎร์ ตำบลฟ้าฮ่าม อำเภอเมืองเชียงใหม่ ใกล้ย่านวัดเกต",
        "เวลาเปิด-ปิด": "ทุกวัน 10.00-16.00 น.",
        "ฤดูกาลแนะนำ": "ตลอดทั้งปี",
        "ช่วงเวลาที่ดีที่สุด": "11.00-13.00 น.",
        "อัตราค่าเข้า": "ฟรี (ราคาอาหารเริ่มต้น 50 บาท)",
        "แผนเที่ยว": "สายกิน/ครอบครัว/เพื่อน"
    },
    {
        "id": 4,
        "ชื่อสถานที่/ร้านอาหาร": "ดอยอ่างขาง",
        "ประเภท": "สถานที่ท่องเที่ยว/จุดชมวิว",
        "รายละเอียด": "สถานีเกษตรหลวงบนดอยสูง ชมดอกไม้เมืองหนาว ซากุระเมืองไทย (พญาเสือโคร่ง) และทะเลหมอก บรรยากาศเย็นสบาย เหมาะสำหรับสายธรรมชาติ",
        "การเดินทาง": "ทางหลวงหมายเลข 107 จากตัวเมืองเชียงใหม่ ไปอำเภอฝาง ต่อด้วยทางหลวง 1249 ระยะทางประมาณ 140 กม.",
        "เวลาเปิด-ปิด": "ทุกวัน 06.00-18.00 น.",
        "ฤดูกาลแนะนำ": "ธันวาคม-มกราคม",
        "ช่วงเวลาที่ดีที่สุด": "06.00-08.00 น.",
        "อัตราค่าเข้า": "ผู้ใหญ่ 50 บาท / เด็ก 20 บาท",
        "แผนเที่ยว": "สายธรรมชาติ/ถ่ายรูป/ครอบครัว"
    },
    {
        "id": 5,
        "ชื่อสถานที่/ร้านอาหาร": "วัดผาลาด",
        "ประเภท": "วัด/สถานที่ท่องเที่ยว",
        "รายละเอียด": "วัดเก่าแก่บนเชิงดอยสุเทพ สถาปัตยกรรมล้านนาโบราณ เงียบสงบ มีน้ำตกเล็กๆ และวิวเมืองเชียงใหม่ เหมาะสำหรับสายบุญและชื่นชอบความสงบ",
        "การเดินทาง": "ถนนศรีวิชัย ระหว่างทางขึ้นดอยสุเทพ อำเภอเมืองเชียงใหม่",
        "เวลาเปิด-ปิด": "ทุกวัน 06.00-17.00 น.",
        "ฤดูกาลแนะนำ": "ตุลาคม-กุมภาพันธ์",
        "ช่วงเวลาที่ดีที่สุด": "08.00-10.00 น.",
        "อัตราค่าเข้า": "ฟรี",
        "แผนเที่ยว": "สายบุญ/ประวัติศาสตร์/ธรรมชาติ"
    },
    {
        "id": 6,
        "ชื่อสถานที่/ร้านอาหาร": "เชียงใหม่ ไนท์ซาฟารี",
        "ประเภท": "สถานที่ท่องเที่ยว/สวนสัตว์",
        "รายละเอียด": "สวนสัตว์กลางคืนที่มีโชว์สัตว์และรถรางให้ชมสัตว์หลากหลายชนิด สนุกสำหรับครอบครัวและเด็กๆ",
        "การเดินทาง": "ถนนหางดง-สะเมิง ตำบลหนองควาย อำเภอหางดง ระยะทางจากตัวเมือง 12 กม.",
        "เวลาเปิด-ปิด": "ทุกวัน 11.00-21.00 น.",
        "ฤดูกาลแนะนำ": "พฤศจิกายน-มีนาคม",
        "ช่วงเวลาที่ดีที่สุด": "18.00-20.00 น.",
        "อัตราค่าเข้า": "ผู้ใหญ่ 800 บาท / เด็ก 400 บาท",
        "แผนเที่ยว": "สายครอบครัว/เด็ก/เพื่อน"
    },
    {
        "id": 7,
        "ชื่อสถานที่/ร้านอาหาร": "คุ้มขันโตก",
        "ประเภท": "ร้านอาหาร/สถานที่ท่องเที่ยว",
        "รายละเอียด": "ร้านอาหารเหนือแบบขันโตก พร้อมการแสดงศิลปะล้านนา เช่น ฟ้อนเล็บ ระบำสี่เผ่า สัมผัสวัฒนธรรมล้านนาแท้ๆ",
        "การเดินทาง": "ถนนเชียงใหม่-ลำพูน ตำบลหนองหอย อำเภอเมืองเชียงใหม่",
        "เวลาเปิด-ปิด": "ทุกวัน 17.30-21.00 น.",
        "ฤดูกาลแนะนำ": "ตลอดทั้งปี",
        "ช่วงเวลาที่ดีที่สุด": "18.00-20.00 น.",
        "อัตราค่าเข้า": "ฟรี (ราคาขันโตกเริ่มต้น 650 บาท/คน)",
        "แผนเที่ยว": "สายกิน/วัฒนธรรม/ครอบครัว"
    },
    {
        "id": 8,
        "ชื่อสถานที่/ร้านอาหาร": "ม่อนแจ่ม",
        "ประเภท": "สถานที่ท่องเที่ยว/จุดชมวิว",
        "รายละเอียด": "จุดชมวิวบนดอยในอำเภอแม่ริม ชมวิวภูเขา ทุ่งดอกไม้ และอากาศเย็นสบาย มีร้านอาหารและที่พักสไตล์ธรรมชาติ",
        "การเดินทาง": "ถนนแม่ริม-สะเมิง อำเภอแม่ริม ระยะทางจากตัวเมือง 40 กม.",
        "เวลาเปิด-ปิด": "ทุกวัน 06.00-18.00 น.",
        "ฤดูกาลแนะนำ": "พฤศจิกายน-กุมภาพันธ์",
        "ช่วงเวลาที่ดีที่สุด": "07.00-09.00 น.",
        "อัตราค่าเข้า": "ฟรี (บางสวนอาจมีค่าเข้า 20-50 บาท)",
        "แผนเที่ยว": "สายธรรมชาติ/ถ่ายรูป/ครอบครัว"
    },
    {
        "id": 9,
        "ชื่อสถานที่/ร้านอาหาร": "ย่านวัดเกต",
        "ประเภท": "ย่าน/สถานที่ท่องเที่ยว",
        "รายละเอียด": "ย่านวัฒนธรรมริมแม่น้ำปิง มีวัดเกตการาม บ้านเรือนเก่าสไตล์ล้านนา ร้านอาหาร และคาเฟ่ บรรยากาศเงียบสงบ",
        "การเดินทาง": "ถนนเจริญราษฎร์ ตำบลช้างม่อย อำเภอเมืองเชียงใหม่",
        "เวลาเปิด-ปิด": "ทุกวัน (ร้านค้าต่างกันไป)",
        "ฤดูกาลแนะนำ": "พฤศจิกายน-มีนาคม",
        "ช่วงเวลาที่ดีที่สุด": "16.00-20.00 น.",
        "อัตราค่าเข้า": "ฟรี",
        "แผนเที่ยว": "สายชิล/วัฒนธรรม/ถ่ายรูป"
    },
    {
        "id": 10,
        "ชื่อสถานที่/ร้านอาหาร": "น้ำตกแม่สา",
        "ประเภท": "สถานที่ท่องเที่ยว/ธรรมชาติ",
        "รายละเอียด": "น้ำตก 10 ชั้นในอุทยานแห่งชาติดอยสุเทพ-ปุย น้ำใสไหลเย็น เหมาะสำหรับปิกนิกและถ่ายรูปท่ามกลางธรรมชาติ",
        "การเดินทาง": "ถนนแม่ริม-สะเมิง อำเภอแม่ริม ระยะทางจากตัวเมือง 30 กม.",
        "เวลาเปิด-ปิด": "ทุกวัน 08.00-17.00 น.",
        "ฤดูกาลแนะนำ": "สิงหาคม-ตุลาคม",
        "ช่วงเวลาที่ดีที่สุด": "09.00-11.00 น.",
        "อัตราค่าเข้า": "ผู้ใหญ่ 100 บาท / เด็ก 50 บาท",
        "แผนเที่ยว": "สายธรรมชาติ/ครอบครัว/ถ่ายรูป"
    }
]

def call_llm(prompt: str, temperature: float = 0.5, max_tokens: int = 100) -> str:
    """
    เรียกใช้งาน LLM (Google Generative AI) เพื่อ generate ข้อความตาม prompt ที่กำหนด
    """
    response = model.generate_content(prompt, generation_config={
        "temperature": temperature,
        "max_output_tokens": max_tokens
    })
    return response.text.strip() if hasattr(response, 'text') else str(response)


def generate_rag_data_with_context(data_point: Dict) -> Dict[str, str]:
    """
    ใช้ LLM เพื่อสร้าง Question, Ground Truth Answer โดยอ้างอิงจาก data_point ที่ให้มา
    และกำหนด Ground Truth Context ให้เป็นข้อมูลจาก data_point นั้น
    """
    print(f"Processing data point: {data_point.get('name', data_point.get('title'))}...")

    # สร้าง Prompt สำหรับ Question
    # LLM จะสร้างคำถามจากข้อมูลใน data_point
    question_prompt = f"""
    จากข้อมูลด้านล่างนี้ โปรดสร้างคำถามที่ผู้ใช้จะถามถึงข้อมูลนี้สำหรับระบบ RAG การท่องเที่ยวเชียงใหม่

    ข้อมูลอ้างอิง:
    {json.dumps(data_point, indent=2, ensure_ascii=False)}

    ตัวอย่างคำถามที่ผู้ใช้อาจจะถาม:
    - "{data_point.get('ชื่อสถานที่/ร้านอาหาร')} มีจุดเด่นอะไร?"
    - "ตัวเลือกการเดินทางในเชียงใหม่สำหรับครอบครัวใหญ่คืออะไร?"
    - "วางแผนเที่ยว {data_point.get('แผนเที่ยว')} ต้องทำอะไรบ้าง?"
    - "วิธีการเดินทางไปวัดพระธาตุดอยสุเทพในเชียงใหม่มีอะไรบ้าง

    คำถาม:
    """
    question = call_llm(question_prompt, temperature=0.5, max_tokens=100)

    # สร้าง Prompt สำหรับ Ground Truth Answer
    # LLM จะสรุปหรือขยายความข้อมูลจาก data_point เพื่อเป็นคำตอบที่สมบูรณ์
    answer_prompt = f"""
    จากข้อมูลอ้างอิงด้านล่าง และคำถาม "{question}" โปรดสร้างคำตอบที่ถูกต้องและสมบูรณ์ที่สุด (Ground Truth Answer)
    โดยใช้ข้อมูลจาก "ข้อมูลอ้างอิง" เท่านั้น และไม่เพิ่มข้อมูลที่ไม่มีอยู่ในข้อมูลอ้างอิง

    ข้อมูลอ้างอิง:
    {json.dumps(data_point, indent=2, ensure_ascii=False)}

    Ground Truth Answer:
    """
    ground_truth_answer = call_llm(answer_prompt, temperature=0.6, max_tokens=300)

    # กำหนด Ground Truth Context
    # ในกรณีนี้ Ground Truth Context คือข้อมูลที่เราป้อนให้ LLM ตั้งแต่แรก (หรือ ID ของมัน)
    # เพื่อให้ง่ายต่อการประเมินว่า Retrieval component ดึงมาได้ถูกต้องหรือไม่
    ground_truth_context_str = f"Document ID: {data_point['id']}\n{json.dumps(data_point, indent=2, ensure_ascii=False)}"

    return {
        "Question": question,
        "Ground Truth Answer": ground_truth_answer,
        "Ground Truth Context": ground_truth_context_str, # เก็บข้อมูลจริงหรือ ID ของเอกสารที่ใช้
        "Actual Retrieved Context": "" # จะเติมในภายหลังจากการรัน RAG
    }

# --- 4. เลือก Subsample จาก Scraped Data เพื่อ Generate ชุดข้อมูล ---
# เพื่อประหยัด API calls และเพื่อให้ได้ข้อมูลที่หลากหลาย
num_samples = 7 # จำนวนตัวอย่างที่จะ Generate (เท่ากับ scraped_data)
sampled_data = random.sample(scraped_data, min(num_samples, len(scraped_data)))

# --- 5. Generate ข้อมูลและเก็บใน List ---
evaluation_data_llm_grounded = []
unique_questions = set()
for dp in sampled_data:
    entry = generate_rag_data_with_context(dp)
    # ตรวจสอบไม่ให้ Question ซ้ำ
    if entry["Question"] not in unique_questions:
        evaluation_data_llm_grounded.append(entry)
        unique_questions.add(entry["Question"])

# --- 6. สร้าง DataFrame ---
df_eval_llm_grounded = pd.DataFrame(evaluation_data_llm_grounded)

print("\n--- Generated RAG Evaluation Dataset (LLM Grounded by Scraped Data) ---")
print(df_eval_llm_grounded)

# --- 7. บันทึกข้อมูลเป็นไฟล์ CSV (Optional) ---
csv_path = "chiangmai_rag_evaluation_dataset_grounded.csv"
file_exists = os.path.isfile(csv_path)
df_eval_llm_grounded.to_csv(csv_path, mode="a", header=not file_exists, index=False, encoding="utf-8-sig")
print(f"\nDataset appended to {csv_path}")